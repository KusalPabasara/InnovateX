<!DOCTYPE html>
<html lang="en" data-theme="corporate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel - Retail Intelligence Platform</title>
    
    <!-- Tailwind CSS + Daisy UI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Professional Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Chart.js with plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --font-primary: 'IBM Plex Sans', system-ui, -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
        }
        
        body {
            font-family: var(--font-primary);
            background: #f8fafc;
        }
        
        [data-theme="dark"] body {
            background: #0f172a;
        }
        
        [data-theme="dark"] {
            background: #0f172a;
        }
        
        .mono {
            font-family: var(--font-mono);
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .gradient-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .gradient-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .gradient-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        [data-theme="dark"] .card-hover:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
        }
        
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        
        /* Chart containers */
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        .chart-wrapper-tall {
            position: relative;
            height: 400px;
        }
        
        /* Stat cards */
        .stat-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="dark"] .stat-card {
            background: #1e293b;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
        }
        
        /* Professional table styling */
        .pro-table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .pro-table th {
            background: #f8fafc;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: #64748b;
        }
        
        [data-theme="dark"] .pro-table th {
            background: #1e293b;
            color: #94a3b8;
        }
        
        .pro-table tbody tr:hover {
            background: #f1f5f9;
        }
        
        [data-theme="dark"] .pro-table tbody tr:hover {
            background: #334155;
        }
        
        /* Container and tab-content dark mode */
        .container {
            background: transparent;
        }
        
        .tab-content {
            background: transparent;
        }
        
        [data-theme="dark"] .tab-content {
            background: transparent;
        }
        
        /* Daisy UI tab overrides for dark mode */
        [data-theme="dark"] .tab-content.bg-base-100 {
            background: #1e293b !important;
        }
        
        [data-theme="dark"] .tabs {
            background: #1e293b;
            border-color: #334155;
        }
        
        [data-theme="dark"] .navbar {
            background: #1e293b;
            border-bottom: 1px solid #334155;
        }
        
        /* Alert dark mode improvements */
        [data-theme="dark"] .alert {
            background: #1e293b;
            border-color: #334155;
        }
        
        [data-theme="dark"] .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: #ef4444;
        }
        
        [data-theme="dark"] .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left-color: #f59e0b;
        }
        
        [data-theme="dark"] .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: #10b981;
        }
        
        [data-theme="dark"] .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-left-color: #3b82f6;
        }
        
        /* Badge dark mode */
        [data-theme="dark"] .badge {
            background: #334155;
            color: #e2e8f0;
        }
        
        [data-theme="dark"] .badge-ghost {
            background: #1e293b;
            border: 1px solid #334155;
        }
        
        /* Progress bar dark mode */
        [data-theme="dark"] .progress {
            background: #334155;
        }
        
        /* Radial progress dark mode */
        [data-theme="dark"] .radial-progress {
            color: #667eea;
        }
        
        /* Text visibility in dark mode */
        [data-theme="dark"] .text-base-content\/60 {
            color: rgba(226, 232, 240, 0.6) !important;
        }
        
        [data-theme="dark"] .text-base-content\/70 {
            color: rgba(226, 232, 240, 0.7) !important;
        }
        
        [data-theme="dark"] .text-base-content {
            color: #e2e8f0 !important;
        }
        
        [data-theme="dark"] .card-title,
        [data-theme="dark"] .stat-card .text-sm,
        [data-theme="dark"] .metric-label,
        [data-theme="dark"] .chart-title {
            color: #e2e8f0 !important;
        }
        
        [data-theme="dark"] .text-xs {
            color: #cbd5e1 !important;
        }
        
        [data-theme="dark"] .uppercase {
            color: #94a3b8 !important;
        }
        
        /* Table text in dark mode */
        [data-theme="dark"] table td,
        [data-theme="dark"] table th {
            color: #e2e8f0;
        }
        
        /* Font weight adjustments for dark mode */
        [data-theme="dark"] .font-bold,
        [data-theme="dark"] .font-semibold {
            color: #f1f5f9;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar bg-base-100 shadow-lg sticky top-0 z-50">
        <div class="flex-1">
            <a class="text-2xl font-bold gradient-text ml-4">
                <i class="fas fa-shield-alt mr-2"></i>SENTINEL
            </a>
            <span class="ml-4 text-sm text-base-content/60">Retail Intelligence Platform</span>
            <span class="ml-4 px-3 py-1 bg-purple-600 text-white rounded-full text-sm font-semibold">Team Gmora</span>
        </div>
        <div class="flex-none gap-2">
            <!-- Live Indicator -->
            <div class="badge badge-success gap-2">
                <span class="pulse-dot w-2 h-2 bg-success rounded-full"></span>
                <span id="status-text">LIVE</span>
            </div>
            
            <!-- Stats Summary -->
            <div class="hidden lg:flex gap-4 mr-4">
                <div class="text-center">
                    <div class="text-xs text-base-content/60">Events</div>
                    <div class="text-lg font-bold mono" id="nav-total">0</div>
                </div>
                <div class="text-center">
                    <div class="text-xs text-base-content/60">Alerts</div>
                    <div class="text-lg font-bold mono text-error" id="nav-alerts">0</div>
                </div>
            </div>
            
            <!-- Theme Toggle -->
            <label class="swap swap-rotate mr-4">
                <input type="checkbox" id="theme-toggle" />
                <i class="fas fa-sun swap-off text-xl"></i>
                <i class="fas fa-moon swap-on text-xl"></i>
            </label>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        
        <!-- Tabs -->
        <div role="tablist" class="tabs tabs-lifted tabs-lg mb-6">
            <input type="radio" name="main_tabs" role="tab" class="tab text-base font-semibold" aria-label="Overview" checked />
            <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                <div id="overview-content"></div>
            </div>

            <input type="radio" name="main_tabs" role="tab" class="tab text-base font-semibold" aria-label="Analytics" />
            <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                <div id="analytics-content"></div>
            </div>

            <input type="radio" name="main_tabs" role="tab" class="tab text-base font-semibold" aria-label="Insights & Predictions" />
            <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                <div id="insights-content"></div>
            </div>

            <input type="radio" name="main_tabs" role="tab" class="tab text-base font-semibold" aria-label="Fraud Detection" />
            <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                <div id="fraud-content"></div>
            </div>

            <input type="radio" name="main_tabs" role="tab" class="tab text-base font-semibold" aria-label="Stations" />
            <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                <div id="stations-content"></div>
            </div>

            <input type="radio" name="main_tabs" role="tab" class="tab text-base font-semibold" aria-label="Inventory" />
            <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                <div id="inventory-content"></div>
            </div>
        </div>

    </div>

    <script>
        // Global variables
        let charts = {};
        let currentTheme = 'corporate';
        let summaryData = null;
        let analyticsData = null;
        let eventsData = [];

        // Theme management
        const themeToggle = document.getElementById('theme-toggle');
        const savedTheme = localStorage.getItem('sentinel-theme') || 'corporate';
        
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            themeToggle.checked = true;
            currentTheme = 'dark';
        }

        themeToggle.addEventListener('change', (e) => {
            const theme = e.target.checked ? 'dark' : 'corporate';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('sentinel-theme', theme);
            currentTheme = theme;
            
            // Redraw all charts with new theme
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            loadAllData();
        });

        // Color schemes
        const colors = {
            primary: ['#667eea', '#764ba2', '#8b5cf6', '#a78bfa'],
            success: ['#10b981', '#059669', '#34d399', '#6ee7b7'],
            warning: ['#f59e0b', '#d97706', '#fbbf24', '#fcd34d'],
            error: ['#ef4444', '#dc2626', '#f87171', '#fca5a5'],
            info: ['#3b82f6', '#2563eb', '#60a5fa', '#93c5fd'],
            slate: ['#64748b', '#475569', '#94a3b8', '#cbd5e1']
        };

        // Load all data
        async function loadAllData() {
            document.getElementById('status-text').textContent = 'UPDATING...';
            
            try {
                const [summaryRes, analyticsRes, eventsRes] = await Promise.all([
                    fetch('/api/summary'),
                    fetch('/api/analytics'),
                    fetch('/api/events?limit=100')
                ]);
                
                summaryData = await summaryRes.json();
                analyticsData = await analyticsRes.json();
                eventsData = (await eventsRes.json()).events;
                
                // Update nav stats
                document.getElementById('nav-total').textContent = summaryData.total_events;
                document.getElementById('nav-alerts').textContent = summaryData.fraud_events;
                
                // Load all tab contents
                loadOverview();
                loadAnalytics();
                loadInsights();
                loadFraud();
                loadStations();
                loadInventory();
                
                document.getElementById('status-text').textContent = 'LIVE';
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('status-text').textContent = 'ERROR';
            }
        }

        // Overview Tab
        function loadOverview() {
            const content = document.getElementById('overview-content');
            
            // Key metrics cards
            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Total Events -->
                    <div class="stat-card card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-sm font-semibold text-base-content/60 uppercase">Total Events</div>
                            <div class="w-12 h-12 rounded-xl gradient-info flex items-center justify-center">
                                <i class="fas fa-chart-line text-white text-xl"></i>
                            </div>
                        </div>
                        <div class="text-4xl font-bold mono mb-2">${summaryData.total_events.toLocaleString()}</div>
                        <div class="text-sm text-base-content/60">All detected events</div>
                    </div>
                    
                    <!-- Fraud Alerts -->
                    <div class="stat-card card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-sm font-semibold text-base-content/60 uppercase">Fraud Alerts</div>
                            <div class="w-12 h-12 rounded-xl gradient-error flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                            </div>
                        </div>
                        <div class="text-4xl font-bold mono mb-2 text-error">${summaryData.fraud_events}</div>
                        <div class="text-sm text-base-content/60">Requires investigation</div>
                    </div>
                    
                    <!-- Operational Events -->
                    <div class="stat-card card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-sm font-semibold text-base-content/60 uppercase">Operational</div>
                            <div class="w-12 h-12 rounded-xl gradient-warning flex items-center justify-center">
                                <i class="fas fa-cog text-white text-xl"></i>
                            </div>
                        </div>
                        <div class="text-4xl font-bold mono mb-2 text-warning">${summaryData.operational_events}</div>
                        <div class="text-sm text-base-content/60">Queue & system alerts</div>
                    </div>
                    
                    <!-- Success Rate -->
                    <div class="stat-card card-hover">
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-sm font-semibold text-base-content/60 uppercase">Success Rate</div>
                            <div class="w-12 h-12 rounded-xl gradient-success flex items-center justify-center">
                                <i class="fas fa-check-circle text-white text-xl"></i>
                            </div>
                        </div>
                        <div class="text-4xl font-bold mono mb-2 text-success">${Math.round((summaryData.normal_events / summaryData.total_events) * 100)}%</div>
                        <div class="text-sm text-base-content/60">Clean transactions</div>
                    </div>
                </div>
            `;
            
            // Alerts section
            if (summaryData.fraud_events > 10) {
                html += `
                    <div class="alert alert-error shadow-lg mb-6">
                        <i class="fas fa-exclamation-circle text-2xl"></i>
                        <div>
                            <h3 class="font-bold">Critical: High Fraud Activity</h3>
                            <div class="text-sm">${summaryData.fraud_events} fraud events detected. Immediate investigation required.</div>
                        </div>
                    </div>
                `;
            }
            
            if (summaryData.operational_events > 100) {
                html += `
                    <div class="alert alert-warning shadow-lg mb-6">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                        <div>
                            <h3 class="font-bold">Warning: High Operational Load</h3>
                            <div class="text-sm">${summaryData.operational_events} operational issues. Consider activating additional stations.</div>
                        </div>
                    </div>
                `;
            }
            
            // Charts
            html += `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="stat-card">
                        <h3 class="text-lg font-bold mb-4">Event Distribution</h3>
                        <div class="chart-wrapper">
                            <canvas id="overview-distribution"></canvas>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3 class="text-lg font-bold mb-4">Station Activity</h3>
                        <div class="chart-wrapper">
                            <canvas id="overview-stations"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // Recent events table
            html += `
                <div class="stat-card">
                    <h3 class="text-lg font-bold mb-4">Recent Events</h3>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra pro-table w-full">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Event Type</th>
                                    <th>Station</th>
                                    <th>Status</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            eventsData.slice(0, 15).forEach(event => {
                const time = new Date(event.timestamp).toLocaleTimeString();
                const badgeClass = getStatusBadge(event.event_id);
                html += `
                    <tr>
                        <td class="mono text-sm">${time}</td>
                        <td class="font-medium">${event.event_data.event_name}</td>
                        <td><span class="badge badge-ghost mono">${event.event_data.station_id || 'N/A'}</span></td>
                        <td><span class="badge ${badgeClass}">${event.event_id}</span></td>
                        <td class="text-sm text-base-content/60">${getEventDetail(event)}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            
            // Create charts
            createDoughnutChart('overview-distribution', 
                ['Fraud', 'Operational', 'Inventory', 'Success'],
                [summaryData.fraud_events, summaryData.operational_events, 
                 summaryData.inventory_events, summaryData.normal_events],
                [colors.error[0], colors.warning[0], colors.info[0], colors.success[0]]
            );
            
            const stationNames = Object.keys(summaryData.station_breakdown);
            const stationCounts = Object.values(summaryData.station_breakdown);
            createBarChart('overview-stations', stationNames, stationCounts, colors.primary[0]);
        }

        // Analytics Tab
        function loadAnalytics() {
            const content = document.getElementById('analytics-content');
            
            let html = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="stat-card text-center">
                        <div class="text-sm font-semibold text-base-content/60 uppercase mb-2">Active Stations</div>
                        <div class="text-5xl font-bold mono gradient-text">${analyticsData.active_stations.length}</div>
                    </div>
                    <div class="stat-card text-center">
                        <div class="text-sm font-semibold text-base-content/60 uppercase mb-2">Avg Events/Station</div>
                        <div class="text-5xl font-bold mono gradient-text">${analyticsData.avg_events_per_station}</div>
                    </div>
                    <div class="stat-card text-center">
                        <div class="text-sm font-semibold text-base-content/60 uppercase mb-2">Peak Hour</div>
                        <div class="text-5xl font-bold mono gradient-text">${getPeakHour()}:00</div>
                    </div>
                </div>
                
                <div class="stat-card mb-6">
                    <h3 class="text-lg font-bold mb-4">Hourly Event Distribution</h3>
                    <div class="chart-wrapper-tall">
                        <canvas id="analytics-hourly"></canvas>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="stat-card">
                        <h3 class="text-lg font-bold mb-4">Event Type Breakdown</h3>
                        <div class="chart-wrapper">
                            <canvas id="analytics-types"></canvas>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3 class="text-lg font-bold mb-4">Station Fraud Rates</h3>
                        <div class="chart-wrapper">
                            <canvas id="analytics-fraud-rates"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            
            // Hourly chart
            const hours = Object.keys(analyticsData.hourly_distribution).sort((a, b) => a - b);
            const hourCounts = hours.map(h => analyticsData.hourly_distribution[h]);
            createLineChart('analytics-hourly', hours.map(h => `${h}:00`), hourCounts);
            
            // Event types
            const eventTypes = Object.keys(analyticsData.event_type_distribution);
            const eventCounts = Object.values(analyticsData.event_type_distribution);
            createBarChart('analytics-types', eventTypes, eventCounts, colors.primary[1]);
            
            // Fraud rates
            const stations = Object.keys(analyticsData.station_stats);
            const fraudRates = stations.map(s => analyticsData.station_stats[s].fraud_rate);
            createBarChart('analytics-fraud-rates', stations, fraudRates, colors.error[0]);
        }

        // Insights & Predictions Tab
        function loadInsights() {
            const content = document.getElementById('insights-content');
            
            // Perform predictive analysis
            const predictions = generatePredictions();
            const riskScore = calculateRiskScore();
            const recommendations = generateRecommendations();
            
            let html = `
                <div class="alert alert-info shadow-lg mb-6">
                    <i class="fas fa-brain text-2xl"></i>
                    <div>
                        <h3 class="font-bold">AI-Powered Insights</h3>
                        <div class="text-sm">Statistical analysis and predictive modeling based on current data patterns</div>
                    </div>
                </div>
                
                <!-- Risk Score -->
                <div class="stat-card mb-6">
                    <h3 class="text-xl font-bold mb-4">Overall Risk Assessment</h3>
                    <div class="flex items-center gap-8">
                        <div class="radial-progress text-6xl" style="--value:${riskScore}; --size:12rem; --thickness: 1rem;" role="progressbar">
                            <span class="text-3xl font-bold">${riskScore}%</span>
                        </div>
                        <div class="flex-1">
                            <div class="text-2xl font-bold mb-2">${getRiskLevel(riskScore)} Risk Level</div>
                            <p class="text-base-content/70">Based on fraud rate, operational load, and historical patterns</p>
                            <div class="mt-4">
                                <div class="text-sm font-semibold mb-1">Risk Factors:</div>
                                <ul class="list-disc list-inside text-sm text-base-content/70">
                                    <li>Fraud Events: ${summaryData.fraud_events} (${((summaryData.fraud_events/summaryData.total_events)*100).toFixed(1)}%)</li>
                                    <li>Operational Load: ${summaryData.operational_events} events</li>
                                    <li>Station Variance: ${calculateStationVariance().toFixed(1)}%</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Predictions -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="stat-card">
                        <h3 class="text-lg font-bold mb-4"><i class="fas fa-chart-line mr-2"></i>Predicted Fraud Types</h3>
                        <div class="space-y-4">
            `;
            
            predictions.forEach(pred => {
                const probability = pred.probability;
                const color = probability > 70 ? 'error' : probability > 40 ? 'warning' : 'info';
                html += `
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="font-medium">${pred.type}</span>
                            <span class="text-sm font-bold text-${color}">${probability}%</span>
                        </div>
                        <progress class="progress progress-${color}" value="${probability}" max="100"></progress>
                        <p class="text-xs text-base-content/60 mt-1">${pred.reasoning}</p>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <h3 class="text-lg font-bold mb-4"><i class="fas fa-lightbulb mr-2"></i>Recommendations</h3>
                        <div class="space-y-3">
            `;
            
            recommendations.forEach(rec => {
                const iconClass = rec.priority === 'high' ? 'error' : rec.priority === 'medium' ? 'warning' : 'info';
                html += `
                    <div class="alert alert-${iconClass}">
                        <i class="fas fa-${rec.icon}"></i>
                        <div class="text-sm">
                            <div class="font-bold">${rec.title}</div>
                            <div>${rec.description}</div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
                
                <!-- Trend Analysis -->
                <div class="stat-card">
                    <h3 class="text-lg font-bold mb-4">Fraud Pattern Analysis</h3>
                    <div class="chart-wrapper-tall">
                        <canvas id="insights-trends"></canvas>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            
            // Create trend chart
            createTrendChart('insights-trends');
        }

        // Fraud Detection Tab
        async function loadFraud() {
            try {
                const response = await fetch('/api/fraud');
                const data = await response.json();
                const content = document.getElementById('fraud-content');
                
                let html = `
                    <div class="stat-card mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-2xl font-bold text-error">${data.total_fraud_events} Fraud Events</h3>
                                <p class="text-base-content/60">Requires immediate investigation</p>
                            </div>
                            <div class="badge badge-error badge-lg">CRITICAL</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <h3 class="text-lg font-bold mb-4">Fraud Event Log</h3>
                        <div class="overflow-x-auto">
                            <table class="table table-zebra pro-table w-full">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Type</th>
                                        <th>Station</th>
                                        <th>Customer</th>
                                        <th>Severity</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.events.slice(0, 25).forEach(event => {
                    const time = new Date(event.timestamp).toLocaleString();
                    html += `
                        <tr>
                            <td class="mono text-xs">${time}</td>
                            <td class="font-medium text-error">${event.event_data.event_name}</td>
                            <td><span class="badge badge-ghost mono">${event.event_data.station_id}</span></td>
                            <td class="mono text-sm">${event.event_data.customer_id || 'N/A'}</td>
                            <td><span class="badge badge-error">HIGH</span></td>
                            <td class="text-sm">${getEventDetail(event)}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading fraud data:', error);
            }
        }

        // Stations Tab
        async function loadStations() {
            try {
                const response = await fetch('/api/stations');
                const data = await response.json();
                const content = document.getElementById('stations-content');
                
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
                
                data.stations.forEach(station => {
                    const statusClass = station.total_events > 100 ? 'warning' : 'success';
                    const statusText = station.total_events > 100 ? 'High Load' : 'Normal';
                    
                    html += `
                        <div class="stat-card card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold mono">${station.station_id}</h3>
                                <span class="badge badge-${statusClass}">${statusText}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center p-3 bg-base-200 rounded-lg">
                                    <div class="text-2xl font-bold mono">${station.total_events}</div>
                                    <div class="text-xs text-base-content/60 uppercase">Events</div>
                                </div>
                                <div class="text-center p-3 bg-base-200 rounded-lg">
                                    <div class="text-2xl font-bold mono text-error">${Object.values(station.event_breakdown).filter(e => e > 0).length}</div>
                                    <div class="text-xs text-base-content/60 uppercase">Types</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading stations:', error);
            }
        }

        // Inventory Tab
        async function loadInventory() {
            try {
                const response = await fetch('/api/inventory');
                const data = await response.json();
                const content = document.getElementById('inventory-content');
                
                let html = `
                    <div class="stat-card mb-6">
                        <h3 class="text-2xl font-bold">${data.total_inventory_events} Inventory Discrepancies</h3>
                        <p class="text-base-content/60">Items with stock mismatches detected</p>
                    </div>
                    
                    <div class="stat-card">
                        <h3 class="text-lg font-bold mb-4">Inventory Issues</h3>
                        <div class="overflow-x-auto">
                            <table class="table table-zebra pro-table w-full">
                                <thead>
                                    <tr>
                                        <th>SKU</th>
                                        <th>Expected</th>
                                        <th>Actual</th>
                                        <th>Difference</th>
                                        <th>Variance %</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.events.forEach(event => {
                    const d = event.event_data;
                    const diff = d.Difference || (d.Actual_Inventory - d.Expected_Inventory);
                    const diffClass = diff < 0 ? 'text-error' : 'text-warning';
                    
                    html += `
                        <tr>
                            <td class="mono font-bold">${d.SKU}</td>
                            <td class="mono">${d.Expected_Inventory}</td>
                            <td class="mono">${d.Actual_Inventory}</td>
                            <td class="mono ${diffClass} font-bold">${diff}</td>
                            <td><span class="badge ${diffClass === 'text-error' ? 'badge-error' : 'badge-warning'}">${d.Difference_Percent || 0}%</span></td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading inventory:', error);
            }
        }

        // Chart creation functions
        function createDoughnutChart(canvasId, labels, data, colors) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const textColor = currentTheme === 'dark' ? '#e2e8f0' : '#212121';
            
            if (charts[canvasId]) charts[canvasId].destroy();
            
            charts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12, family: 'IBM Plex Sans' },
                                color: textColor
                            }
                        }
                    }
                }
            });
        }

        function createBarChart(canvasId, labels, data, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const textColor = currentTheme === 'dark' ? '#e2e8f0' : '#212121';
            const gridColor = currentTheme === 'dark' ? '#334155' : '#f1f5f9';
            
            if (charts[canvasId]) charts[canvasId].destroy();
            
            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: color,
                        borderRadius: 8,
                        barThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor }
                        }
                    }
                }
            });
        }

        function createLineChart(canvasId, labels, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const textColor = currentTheme === 'dark' ? '#e2e8f0' : '#212121';
            const gridColor = currentTheme === 'dark' ? '#334155' : '#f1f5f9';
            
            if (charts[canvasId]) charts[canvasId].destroy();
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(102, 126, 234, 0.5)');
            gradient.addColorStop(1, 'rgba(118, 75, 162, 0.0)');
            
            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: gradient,
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor }
                        }
                    }
                }
            });
        }

        function createTrendChart(canvasId) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const textColor = currentTheme === 'dark' ? '#e2e8f0' : '#212121';
            const gridColor = currentTheme === 'dark' ? '#334155' : '#f1f5f9';
            
            if (charts[canvasId]) charts[canvasId].destroy();
            
            // Simulate trend data
            const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
            const scannerAvoidance = hours.map(() => Math.floor(Math.random() * 5));
            const barcodeSwitch = hours.map(() => Math.floor(Math.random() * 4));
            const weightDiscrep = hours.map(() => Math.floor(Math.random() * 3));
            
            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [
                        {
                            label: 'Scanner Avoidance',
                            data: scannerAvoidance,
                            borderColor: colors.error[0],
                            backgroundColor: colors.error[0] + '33',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Barcode Switching',
                            data: barcodeSwitch,
                            borderColor: colors.warning[0],
                            backgroundColor: colors.warning[0] + '33',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Weight Discrepancies',
                            data: weightDiscrep,
                            borderColor: colors.info[0],
                            backgroundColor: colors.info[0] + '33',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { 
                                font: { family: 'IBM Plex Sans' },
                                color: textColor
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor }
                        }
                    }
                }
            });
        }

        // Prediction & Analysis Functions
        function generatePredictions() {
            const fraudRate = (summaryData.fraud_events / summaryData.total_events) * 100;
            
            // Count events by type from event_breakdown (keys are event names, values are counts)
            const scannerCount = Object.entries(summaryData.event_breakdown || {})
                .filter(([name, count]) => name.includes('Scanner') || name.includes('Avoidance'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const barcodeCount = Object.entries(summaryData.event_breakdown || {})
                .filter(([name, count]) => name.includes('Barcode') || name.includes('Switching'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            const weightCount = Object.entries(summaryData.event_breakdown || {})
                .filter(([name, count]) => name.includes('Weight') || name.includes('Discrepancy'))
                .reduce((sum, [, count]) => sum + count, 0);
            
            return [
                {
                    type: 'Scanner Avoidance',
                    probability: Math.min(95, Math.floor(fraudRate * 1.5 + (scannerCount > 0 ? 25 : 15))),
                    reasoning: scannerCount > 0 ? 
                        `${scannerCount} incidents detected. High historical occurrence` : 
                        'Moderate risk based on fraud patterns'
                },
                {
                    type: 'Barcode Switching',
                    probability: Math.min(85, Math.floor(fraudRate * 1.2 + (barcodeCount > 0 ? 20 : 12))),
                    reasoning: barcodeCount > 0 ? 
                        `${barcodeCount} incidents detected. Increasing trend in self-checkout` : 
                        'Emerging pattern detected in transaction data'
                },
                {
                    type: 'Weight Discrepancies',
                    probability: Math.min(70, Math.floor(fraudRate * 0.8 + (weightCount > 0 ? 15 : 10) + 20)),
                    reasoning: weightCount > 0 ? 
                        `${weightCount} discrepancies found. Moderate risk` : 
                        'Moderate risk based on product mix patterns'
                },
                {
                    type: 'System Exploitation',
                    probability: Math.min(60, Math.floor(fraudRate * 0.5 + 35)),
                    reasoning: 'Low current occurrence, but potential for organized attempts'
                }
            ];
        }

        function calculateRiskScore() {
            const fraudRate = (summaryData.fraud_events / summaryData.total_events) * 100;
            const operationalLoad = (summaryData.operational_events / summaryData.total_events) * 100;
            const variance = calculateStationVariance();
            
            return Math.min(100, Math.floor(fraudRate * 2 + operationalLoad * 0.5 + variance * 0.3));
        }

        function getRiskLevel(score) {
            if (score >= 75) return 'Critical';
            if (score >= 50) return 'High';
            if (score >= 25) return 'Medium';
            return 'Low';
        }

        function calculateStationVariance() {
            const counts = Object.values(summaryData.station_breakdown);
            const mean = counts.reduce((a, b) => a + b, 0) / counts.length;
            const variance = counts.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / counts.length;
            return Math.sqrt(variance);
        }

        function generateRecommendations() {
            const recommendations = [];
            
            if (summaryData.fraud_events > 20) {
                recommendations.push({
                    priority: 'high',
                    icon: 'shield-alt',
                    title: 'Increase Security Monitoring',
                    description: 'Deploy additional staff to self-checkout areas'
                });
            }
            
            if (summaryData.operational_events > 150) {
                recommendations.push({
                    priority: 'high',
                    icon: 'plus-circle',
                    title: 'Activate Additional Stations',
                    description: 'Open SCC3 and SCC4 to reduce queue times'
                });
            }
            
            recommendations.push({
                priority: 'medium',
                icon: 'chart-line',
                title: 'Review High-Risk Periods',
                description: 'Analyze peak hours for targeted interventions'
            });
            
            recommendations.push({
                priority: 'low',
                icon: 'user-shield',
                title: 'Staff Training',
                description: 'Update team on latest fraud patterns'
            });
            
            return recommendations;
        }

        // Helper functions
        function getStatusBadge(eventId) {
            if (['E001', 'E002', 'E003'].includes(eventId)) return 'badge-error';
            if (['E004', 'E005', 'E006', 'E008'].includes(eventId)) return 'badge-warning';
            if (eventId === 'E007') return 'badge-info';
            return 'badge-success';
        }

        function getEventDetail(event) {
            const d = event.event_data;
            if (d.customer_id) return `Customer: ${d.customer_id}`;
            if (d.product_sku) return `SKU: ${d.product_sku}`;
            if (d.num_of_customers) return `Queue: ${d.num_of_customers}`;
            if (d.wait_time_seconds) return `Wait: ${d.wait_time_seconds}s`;
            return '-';
        }

        function getPeakHour() {
            const hours = Object.keys(analyticsData.hourly_distribution);
            const max = Math.max(...Object.values(analyticsData.hourly_distribution));
            return hours.find(h => analyticsData.hourly_distribution[h] === max) || '12';
        }

        // Initialize
        loadAllData();
        
        // Auto-refresh every 5 seconds
        setInterval(loadAllData, 5000);
    </script>

    <!-- Footer -->
    <footer class="footer footer-center p-6 bg-base-100 text-base-content border-t border-base-300 mt-8">
        <div class="grid grid-flow-col gap-4">
            <div class="flex items-center gap-2">
                <i class="fas fa-shield-alt text-purple-600"></i>
                <span class="font-bold gradient-text">SENTINEL</span>
                <span class="text-base-content/60">|</span>
                <span class="text-base-content/80">Retail Intelligence Platform</span>
            </div>
        </div>
        <div>
            <div class="flex items-center gap-3">
                <span class="px-4 py-2 bg-purple-600 text-white rounded-full font-semibold">
                    <i class="fas fa-users mr-2"></i>Team Gmora
                </span>
                <span class="text-base-content/60">|</span>
                <span class="text-base-content/70">Project Sentinel © 2025</span>
            </div>
        </div>
    </footer>
</body>
</html>
